_format_version: "3.0"
_transform: true
_konnect:
  control_plane_name: tcsai

_info:
  select_tags:
  - ai_rag

services:
  - name: ai-chat-with-rag
    url: https://${azure_instance}.openai.azure.com
    routes:
      - name: chat-route
        paths:
          - /v1/chat/completions
        methods:
          - POST
    plugins:
      - name: ai-rag-injector
        config:
          embeddings:
            auth:
              header_name: api-key
              header_value: ${api-key}
            model:
              provider: azure
              name: ${embedding_name}
              options:
                azure_instance: ${azure_instance}
                azure_api_version: ${azure_api_version}
                azure_deployment_id: ${azure_deployment_id}
          
          vectordb:
            strategy: redis
            redis:
              host: redis-15934.crce206.ap-south-1-1.ec2.redns.redis-cloud.com
              port: 15934
              username: default
              password: ${redis_pwd}
              ssl: false
              index:
                name: hr_mitr_index
                metric: cosine
                dimensions: 1536
          
          top_k: 5
          threshold: 0.7
      
      - name: ai-proxy
        config:
          route_type: llm/v1/chat
          auth:
            header_name: api-key
            header_value: ${api-key}
          model:
            provider: azure
            name: ${azure_deployment_id}
            options:
              azure_instance: ${azure_instance}
              azure_api_version: "${azure_api_version}"
              azure_deployment_id: ${azure_deployment_id}

  - name: doc-ingestion
    url: http://localhost:8080
    routes:
      - name: ingest-route
        paths:
          - /v1/ingest
        methods:
          - POST
    plugins:
      - name: doc-embedder
        config:
          azure_endpoint: "https://${azure_instance}.openai.azure.com"
          deployment: "BTG_text-embedding-ada-002"
          api_version: ${api_version}
          azure_api_key: "${api_key}"
          redis_url: "redis://default:${redis_pwd}@redis-15934.crce206.ap-south-1-1.ec2.redns.redis-cloud.com:15934"
          redis_index: "hr_mitr_index"
          redis_prefix: "doc:"
          chunk_size: 500
          chunk_overlap: 50
          max_chunks: 50
          embedding_dim: 1536